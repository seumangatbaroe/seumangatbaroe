<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Bad Stock</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --accent1:#007BFF;--accent2:#00B4D8;
  --bg-1:#051426;--bg-2:#071b36;--muted:#9aa6bf;
  --card-bg:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1);
  --text:#ffffff;--surface:rgba(255,255,255,0.03);
}
body.light-mode{
  --bg-1:#f6f8fb;--bg-2:#e9f0fb;
  --card-bg:rgba(2,6,23,0.04);--glass-border:rgba(2,6,23,0.08);
  --text:#0b1724;--muted:#40546b;--surface:rgba(11,23,36,0.04);
}
body{
  margin:0;font-family:'Poppins',sans-serif;color:var(--text);
  background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
  padding:20px;transition:background 0.6s,color 0.6s;
}
header{
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  flex-wrap:wrap;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo i{
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:white;width:48px;height:48px;display:flex;
  align-items:center;justify-content:center;border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
.title h1{margin:0;font-size:20px;font-weight:700;}
.title p{margin:0;font-size:13px;color:var(--muted);}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.btn{
  border:0;padding:8px 14px;border-radius:8px;cursor:pointer;
  font-weight:500;transition:0.25s;
}
.btn:hover{transform:translateY(-2px);opacity:0.9;}
.btn-ghost{
  background:transparent;border:1px solid var(--glass-border);color:var(--text);
  backdrop-filter:blur(4px);
}
.btn-primary{
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:white;box-shadow:0 2px 8px rgba(0,123,255,0.3);
}
.layout{
  display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:22px;
}
.cards{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}
.card{
  background:var(--card-bg);border:1px solid var(--glass-border);
  border-radius:14px;padding:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  backdrop-filter:blur(6px);transition:0.3s;
}
.card:hover{transform:translateY(-3px);}
.card h3{margin:0;font-size:13px;color:var(--muted);font-weight:500;}
.card .value{font-size:22px;font-weight:700;margin-top:6px;}
.table-wrap{
  margin-top:18px;background:var(--card-bg);
  border:1px solid var(--glass-border);border-radius:12px;padding:12px;
  backdrop-filter:blur(6px);
}
table{width:100%;border-collapse:collapse;}
thead th{
  text-align:left;padding:8px;font-size:12px;color:var(--muted);
  border-bottom:1px solid rgba(255,255,255,0.08);
}
tbody td{
  padding:8px;font-size:14px;border-bottom:1px dashed rgba(255,255,255,0.05);
}
tr:hover td{background:rgba(255,255,255,0.05);transition:0.3s;}
.filter-bar{
  display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;align-items:center;
}
.filter-bar select,.filter-bar input{
  background:var(--surface);border:1px solid var(--glass-border);
  color:var(--text);padding:7px 10px;border-radius:8px;font-size:13px;
  transition:0.2s;
}
.filter-bar select:hover,.filter-bar input:hover{border-color:var(--accent1);}
.filter-bar select:focus,.filter-bar input:focus{
  outline:none;border-color:var(--accent2);
}
.search-box{position:relative;display:flex;align-items:center;}
.search-box input{padding-left:28px !important;}
.search-box i{position:absolute;left:8px;color:var(--muted);}
@media(max-width:1000px){.layout{grid-template-columns:1fr;}}
@media(max-width:600px){header{flex-direction:column;align-items:flex-start;}.cards{grid-template-columns:1fr;}}
</style>
</head>

<body>
<header>
  <div class="logo">
    <i class="fa-solid fa-boxes-stacked"></i>
    <div class="title">
      <h1>Dashboard Bad Stock</h1>
      <p id="smallDate">–</p>
    </div>
  </div>
  <div class="controls">
    <button class="btn btn-ghost" id="themeToggle"><i id="themeIcon" class="fa-solid fa-sun"></i></button>
    <button class="btn btn-primary" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Refresh</button>
    <button class="btn btn-ghost" id="downloadExcel"><i class="fa-solid fa-file-excel"></i> Excel</button>
    <button class="btn btn-ghost" id="downloadPDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
    <button class="btn btn-ghost" id="backButton"><i class="fa-solid fa-arrow-left"></i> Back</button>
  </div>
</header>

<section class="layout">
  <div>
    <div class="cards">
      <div class="card"><h3>Total Bad Stock</h3><div class="value" id="totalPenjualan">Rp0</div></div>
      <div class="card"><h3>Jumlah Sales</h3><div class="value" id="totalSales">0</div></div>
      <div class="card"><h3>Jumlah Prinsipal</h3><div class="value" id="totalPrinsipal">0</div></div>
    </div>

    <div class="table-wrap">
      <div class="filter-bar">
        <select id="filterSales"><option value="">Semua Sales</option></select>
        <select id="filterPrinsipal"><option value="">Semua Prinsipal</option></select>
        <select id="filterToko"><option value="">Semua Toko</option></select>
        <label>Dari:</label>
        <input type="date" id="filterStartDate" />
        <label>Sampai:</label>
        <input type="date" id="filterEndDate" />
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="searchBox" placeholder="🔍 Cari toko / prinsipal..." />
        </div>
        <button class="btn btn-ghost" id="clearFilter"><i class="fa-solid fa-filter-circle-xmark"></i> Reset</button>
      </div>

      <table id="dashboardTable">
        <thead>
          <tr>
            <th>No</th><th>Tanggal</th><th>Nama Sales</th><th>Toko</th><th>Prinsipal</th><th style="text-align:right">Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <aside>
    <div class="card"><canvas id="chartPenjualan"></canvas></div>
  </aside>
</section>

<script>
const SHEET_URL = `https://sheets.googleapis.com/v4/spreadsheets/1sIBT9kdkvZvW3ULIMOARDAFXuXQxLRbpFASVaLromPw/values/BS?key=AIzaSyBWHJnEPSkzvDrECNzZBu-KYPGvOX-rRu0`;

const tbody=document.querySelector('#dashboardTable tbody');
const totalPenjualanEl=document.getElementById('totalPenjualan');
const totalSalesEl=document.getElementById('totalSales');
const totalPrinsipalEl=document.getElementById('totalPrinsipal');
const filterSales=document.getElementById('filterSales');
const filterPrinsipal=document.getElementById('filterPrinsipal');
const filterToko=document.getElementById('filterToko');
const filterStartDate=document.getElementById('filterStartDate');
const filterEndDate=document.getElementById('filterEndDate');
const clearFilter=document.getElementById('clearFilter');
const searchBox=document.getElementById('searchBox');

let dataAll=[],chart1,filteredData=[];

function parseTanggal(tglStr){if(!tglStr)return'';tglStr=tglStr.trim();
if(/^\d{4}-\d{2}-\d{2}$/.test(tglStr))return tglStr;
const m=tglStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
if(m){const d=m[1].padStart(2,'0');const mo=m[2].padStart(2,'0');const y=m[3].length===2?'20'+m[3]:m[3];return`${y}-${mo}-${d}`;}
const num=Number(tglStr);if(!isNaN(num)&&num>40000&&num<60000){const baseDate=new Date(1899,11,30);baseDate.setDate(baseDate.getDate()+num);return baseDate.toISOString().split('T')[0];}
return'';}
function tampilTanggal(tglStr){const[y,m,d]=tglStr.split('-');return`${d}/${m}/${y}`;}
function parseRupiah(str){if(!str)return 0;str=str.toString().replace(/[^\d,-]/g,'').replace(',','.');const num=parseFloat(str);return isNaN(num)?0:num;}
const formatRupiah=(v)=>new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(v||0);

async function loadData(){
try{
const res=await fetch(SHEET_URL);
const json=await res.json();
if(!json.values||json.values.length<2){tbody.innerHTML='<tr><td colspan="6">Tidak ada data</td></tr>';return;}
const [, ...rows]=json.values;
dataAll=rows.map(r=>({TanggalISO:parseTanggal(r[0]||''),Tanggal:r[0]||'',NamaSales:r[1]||'',Toko:r[2]||'',Prinsipal:r[3]||'',Total:parseRupiah(r[4]),}));
populateFilters(dataAll);applyFilter();
document.getElementById("smallDate").textContent=new Date().toLocaleDateString("id-ID",{weekday:"short",day:"2-digit",month:"short",year:"numeric"});
}catch(e){console.error(e);tbody.innerHTML='<tr><td colspan="6">Gagal mengambil data</td></tr>';}}
function populateFilters(data){const salesList=[...new Set(data.map(d=>d.NamaSales))].sort();const prinsipalList=[...new Set(data.map(d=>d.Prinsipal))].sort();const tokoList=[...new Set(data.map(d=>d.Toko))].sort();
filterSales.innerHTML='<option value="">Semua Sales</option>'+salesList.map(s=>`<option>${s}</option>`).join('');
filterPrinsipal.innerHTML='<option value="">Semua Prinsipal</option>'+prinsipalList.map(p=>`<option>${p}</option>`).join('');
filterToko.innerHTML='<option value="">Semua Toko</option>'+tokoList.map(t=>`<option>${t}</option>`).join('');}

function applyFilter(){
filteredData=[...dataAll];
if(filterSales.value)filteredData=filteredData.filter(d=>d.NamaSales===filterSales.value);
if(filterPrinsipal.value)filteredData=filteredData.filter(d=>d.Prinsipal===filterPrinsipal.value);
if(filterToko.value)filteredData=filteredData.filter(d=>d.Toko===filterToko.value);
const startDate=filterStartDate.value?new Date(filterStartDate.value):null;
const endDate=filterEndDate.value?new Date(filterEndDate.value):null;
if(startDate||endDate){filteredData=filteredData.filter(d=>{const tgl=new Date(d.TanggalISO);if(isNaN(tgl))return true;if(startDate&&tgl<startDate)return false;if(endDate&&tgl>endDate)return false;return true;});}
const keyword=searchBox.value.trim().toLowerCase();
if(keyword){filteredData=filteredData.filter(d=>d.Toko.toLowerCase().includes(keyword)||d.Prinsipal.toLowerCase().includes(keyword));}
renderTable(filteredData);updateCards(filteredData);renderChart(filteredData);
}

function renderTable(data){tbody.innerHTML="";if(data.length===0){tbody.innerHTML='<tr><td colspan="6">Tidak ada data</td></tr>';return;}
data.forEach((r,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${r.TanggalISO?tampilTanggal(r.TanggalISO):r.Tanggal}</td><td>${r.NamaSales}</td><td>${r.Toko}</td><td>${r.Prinsipal}</td><td style="text-align:right">${formatRupiah(r.Total)}</td>`;tbody.appendChild(tr);});}

function updateCards(data){const total=data.reduce((sum,d)=>sum+d.Total,0);
totalPenjualanEl.textContent=formatRupiah(total);
totalSalesEl.textContent=new Set(data.map(d=>d.NamaSales)).size;
totalPrinsipalEl.textContent=new Set(data.map(d=>d.Prinsipal)).size;}

function renderChart(data){const ctx=document.getElementById("chartPenjualan").getContext("2d");if(chart1)chart1.destroy();
const perSales={};data.forEach(d=>{perSales[d.NamaSales]=(perSales[d.NamaSales]||0)+d.Total;});
chart1=new Chart(ctx,{type:"bar",data:{labels:Object.keys(perSales),datasets:[{label:"Total Bad Stock",data:Object.values(perSales),backgroundColor:"rgba(0,123,255,0.6)",borderRadius:6}]},
options:{animation:{duration:800,easing:'easeOutQuart'},plugins:{legend:{labels:{color:document.body.classList.contains('light-mode')?'#000':'#fff'}}},
scales:{x:{ticks:{color:document.body.classList.contains('light-mode')?'#000':'#fff'}},y:{ticks:{color:document.body.classList.contains('light-mode')?'#000':'#fff'}}},},});}

[filterSales,filterPrinsipal,filterToko,filterStartDate,filterEndDate].forEach(el=>el.onchange=applyFilter);
searchBox.oninput=applyFilter;
clearFilter.onclick=()=>{filterSales.value=filterPrinsipal.value=filterToko.value=filterStartDate.value=filterEndDate.value='';searchBox.value='';applyFilter();};
document.getElementById("themeToggle").onclick=()=>{document.body.classList.toggle("light-mode");
document.getElementById("themeIcon").className=document.body.classList.contains("light-mode")?"fa-solid fa-moon":"fa-solid fa-sun";renderChart(filteredData);};
document.getElementById("refreshBtn").onclick=loadData;
document.getElementById("backButton").onclick=()=>window.history.back();

// ✅ Download Excel
document.getElementById("downloadExcel").onclick=()=>{
  if(filteredData.length===0){alert("Tidak ada data untuk diunduh!");return;}
  const ws=XLSX.utils.json_to_sheet(filteredData.map((r,i)=>({
    No:i+1,
    Tanggal:r.TanggalISO?tampilTanggal(r.TanggalISO):r.Tanggal,
    Nama_Sales:r.NamaSales,
    Toko:r.Toko,
    Prinsipal:r.Prinsipal,
    Total:formatRupiah(r.Total)
  })));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Bad Stock");
  XLSX.writeFile(wb,"BadStock.xlsx");
};

// ✅ Download PDF
document.getElementById("downloadPDF").onclick=()=>{
  if(filteredData.length===0){alert("Tidak ada data untuk diunduh!");return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('p','pt','a4');
  doc.text("Laporan Bad Stock",40,40);
  doc.autoTable({
    startY:60,
    head:[["No","Tanggal","Nama Sales","Toko","Prinsipal","Total"]],
    body:filteredData.map((r,i)=>[
      i+1,
      r.TanggalISO?tampilTanggal(r.TanggalISO):r.Tanggal,
      r.NamaSales,
      r.Toko,
      r.Prinsipal,
      formatRupiah(r.Total)
    ]),
    styles:{fontSize:8},
    headStyles:{fillColor:[0,123,255]},
  });
  doc.save("BadStock.pdf");
};

loadData();
</script>
</body>
</html>
