<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Biaya Operasional</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --accent1:#007BFF; --accent2:#0056d6;
    --bg-1:#061223; --bg-2:#071833;
    --muted:#9aa6bf; --text:#fff;
    --card-bg:rgba(255,255,255,0.02); --glass-border:rgba(255,255,255,0.06);
    --positive:#10b981; --negative:#ef4444; --neutral:#94a3b8;
  }
  body.light-mode{
    --bg-1:#f6f8fb;--bg-2:#eef3fb;--text:#0b1724;--muted:#40546b;
    --card-bg:#ffffff;--glass-border:rgba(0,0,0,0.08);
  }
  body{
    margin:0;padding:18px;font-family:Poppins,sans-serif;color:var(--text);
    background:radial-gradient(1200px 500px at 10% 10%,rgba(0,123,255,0.06),transparent),
               radial-gradient(1000px 400px at 90% 90%,rgba(0,86,214,0.04),transparent),
               linear-gradient(180deg,var(--bg-1),var(--bg-2));
    transition:background .3s,color .3s;
  }
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  header h1{margin:0;font-size:20px}
  header p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:12px}
  .card{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:12px;padding:14px;backdrop-filter:blur(6px);box-shadow:0 8px 20px rgba(0,0,0,0.18);display:flex;flex-direction:column;justify-content:space-between;min-height:72px;transition:background .3s,color .3s;}
  .card h3{margin:0;font-size:13px;color:var(--muted)}
  .card .value{font-size:20px;font-weight:800;margin-top:8px}
  .card.small{padding:10px;min-height:60px}
  .card-saldo{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;}
  .saldo-value{font-size:22px;font-weight:900}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .filters select,.filters input{background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:6px}
  .filters label{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .reset-btn{
    background:var(--accent1);color:white;border:none;border-radius:6px;
    padding:6px 12px;cursor:pointer;font-size:13px;transition:background .2s;
  }
  .reset-btn:hover{background:var(--accent2);}
  table{width:100%;border-collapse:collapse;color:var(--text);font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:middle}
  th{color:var(--muted);text-align:left}
  td.right{text-align:right}
  tr:hover td{background:rgba(255,255,255,0.02)}
  canvas{background:transparent;border-radius:8px}
  button{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.15);border-radius:6px;padding:6px 10px;cursor:pointer;transition:background .3s,color .3s;}
  button:hover{background:rgba(255,255,255,0.1);}
  @media (max-width:820px){.cards-grid{grid-template-columns:repeat(1,1fr)}}
</style>
</head>
<body>

<header>
  <div>
    <h1>Dashboard Biaya Operasional</h1>
    <p id="smallDate">â€”</p>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="themeToggle" title="Light / Dark"><i id="themeIcon" class="fa-solid fa-sun"></i></button>
    <button id="exportExcel" title="Download Excel"><i class="fa-regular fa-file-excel"></i>&nbsp;Excel</button>
    <button id="exportPdf" title="Download PDF"><i class="fa-regular fa-file-pdf"></i>&nbsp;PDF</button>
    <button id="backButton" title="Kembali ke halaman sebelumnya"><i class="fa-solid fa-arrow-left"></i>&nbsp;Back</button>
  </div>
</header>

<!-- Cards -->
<div class="cards-grid" id="cardsArea">
  <div class="card card-saldo small" id="cardSaldo">
    <div class="label">ðŸ’° Total Saldo</div>
    <div class="value saldo-value" id="totalSaldo">Rp0</div>
  </div>
  <div class="card small"><h3>Total Debet</h3><div class="value" id="totalDebet">Rp0</div></div>
  <div class="card small"><h3>Total Credit</h3><div class="value" id="totalCredit">Rp0</div></div>
  <div class="card small"><h3>Total Transfer</h3><div class="value" id="totalTransfer">Rp0</div></div>
</div>

<!-- Filters -->
<div class="controls filters" style="margin-bottom:14px">
  <label>Dari: <input type="date" id="filterStart"/></label>
  <label>Sampai: <input type="date" id="filterEnd"/></label>
  <select id="filterKategori"><option value="">Semua Kategori</option></select>
  <select id="filterNopol"><option value="">Semua Nopol</option></select>
  <select id="filterJenisTransaksi">
    <option value="">Semua Jenis</option>
    <option value="Debet">Debet</option>
    <option value="Credit">Credit</option>
    <option value="Transfer">Transfer</option>
  </select>
  <input id="quickSearch" placeholder="Cari keteranganâ€¦" style="padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text)"/>
  <button class="reset-btn" id="resetFilters"><i class="fa-solid fa-rotate-right"></i> Reset Filter</button>
</div>

<!-- Table -->
<div style="overflow:auto;margin-bottom:12px">
  <table id="tableBiaya">
    <thead>
      <tr>
        <th>No</th><th>Tanggal</th><th>Nopol</th><th>Kategori</th>
        <th style="text-align:right">Debet</th><th style="text-align:right">Credit</th><th style="text-align:right">Transfer</th><th>Keterangan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Chart -->
<canvas id="chartBiaya" style="height:320px;width:100%"></canvas>

<script>
const SHEET_URL = `https://sheets.googleapis.com/v4/spreadsheets/1sIBT9kdkvZvW3ULIMOARDAFXuXQxLRbpFASVaLromPw/values/Biaya OP?key=AIzaSyBWHJnEPSkzvDrECNzZBu-KYPGvOX-rRu0`;
const tbody = document.querySelector('#tableBiaya tbody');
const totalDebetEl = document.getElementById('totalDebet');
const totalCreditEl = document.getElementById('totalCredit');
const totalTransferEl = document.getElementById('totalTransfer');
const totalSaldoEl = document.getElementById('totalSaldo');
const filterKategori = document.getElementById('filterKategori');
const filterNopol = document.getElementById('filterNopol');
const filterJenisTransaksi = document.getElementById('filterJenisTransaksi');
const quickSearch = document.getElementById('quickSearch');
const filterStart = document.getElementById('filterStart');
const filterEnd = document.getElementById('filterEnd');
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const exportExcelBtn = document.getElementById('exportExcel');
const exportPdfBtn = document.getElementById('exportPdf');
let dataAll = [], filtered = [], chart;

// Mode Siang / Malam
function applyTheme(theme) {
  if (theme === 'light') {
    document.body.classList.add('light-mode');
    themeIcon.classList.replace('fa-moon', 'fa-sun');
  } else {
    document.body.classList.remove('light-mode');
    themeIcon.classList.replace('fa-sun', 'fa-moon');
  }
  localStorage.setItem('theme', theme);
  if (chart) renderChart();
}

themeToggle.addEventListener('click', () => {
  const isLight = document.body.classList.contains('light-mode');
  applyTheme(isLight ? 'dark' : 'light');
});
applyTheme(localStorage.getItem('theme') || 'dark');

function formatRupiah(v){return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(Number(v)||0);}
function formatTanggalInput(d){if(!d)return'';const dt=new Date(d);if(isNaN(dt))return d;return dt.toLocaleDateString('id-ID');}
function escapeHtml(s){if(typeof s!=='string')return s;return s.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));}

async function loadData(){
  try{
    const res=await fetch(SHEET_URL);const json=await res.json();
    const [header,...rows]=json.values||[];
    if(!rows||rows.length===0){tbody.innerHTML='<tr><td colspan="8">Tidak ada data</td></tr>';return;}
    dataAll=rows.map(r=>{const o={};header.forEach((h,i)=>o[h]=r[i]||'');o.Debet=+o.Debet||0;o.Credit=+o.Credit||0;o.Transfer=+o.Transfer||0;return o;});
    populateFilters();applyFilters();updateHeaderDate();
  }catch(e){console.error(e);tbody.innerHTML='<tr><td colspan="8">Gagal memuat data</td></tr>';}
}

function populateFilters(){
  const cats=[...new Set(dataAll.map(d=>d.Kategori))].filter(Boolean).sort();
  const nops=[...new Set(dataAll.map(d=>d.Nopol))].filter(Boolean).sort();
  [filterKategori,filterNopol].forEach(sel=>sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove()));
  cats.forEach(c=>filterKategori.appendChild(new Option(c,c)));
  nops.forEach(n=>filterNopol.appendChild(new Option(n,n)));
}

function applyFilters(){
  const kat=filterKategori.value,nop=filterNopol.value,jenis=filterJenisTransaksi.value,q=(quickSearch.value||'').trim().toLowerCase();
  const start=filterStart.value?new Date(filterStart.value):null,end=filterEnd.value?new Date(filterEnd.value):null;
  filtered=dataAll.filter(r=>{
    if(kat&&r.Kategori!==kat)return false;
    if(nop&&r.Nopol!==nop)return false;
    if(jenis==='Debet' && (!r.Debet || r.Debet<=0))return false;
    if(jenis==='Credit' && (!r.Credit || r.Credit<=0))return false;
    if(jenis==='Transfer' && (!r.Transfer || r.Transfer<=0))return false;
    if(q&&!(`${r.Keterangan||''} ${r.Nopol||''} ${r.Kategori||''}`.toLowerCase().includes(q)))return false;
    if(start||end){
      let t=new Date(r.Tanggal);
      if(isNaN(t)){
        const p=(r.Tanggal||'').split('/');
        if(p.length===3){t=new Date(`${p[2].length===2?'20'+p[2]:p[2]}-${p[1]}-${p[0]}`);}else return false;
      }
      if(start&&t<start)return false;if(end&&t>end)return false;
    }
    return true;
  });
  renderTable();updateCardsAndSaldo();renderChart();
}

function renderTable(){
  tbody.innerHTML=filtered.length?filtered.map((r,i)=>`
  <tr>
    <td>${i+1}</td><td>${formatTanggalInput(r.Tanggal)}</td>
    <td>${escapeHtml(r.Nopol)}</td><td>${escapeHtml(r.Kategori)}</td>
    <td class="right">${formatRupiah(r.Debet)}</td>
    <td class="right">${formatRupiah(r.Credit)}</td>
    <td class="right">${formatRupiah(r.Transfer)}</td>
    <td>${escapeHtml(r.Keterangan)}</td>
  </tr>`).join(''):'<tr><td colspan="8">Tidak ada data</td></tr>';
}

function updateCardsAndSaldo(){
  const t=filtered.reduce((s,x)=>{s.d+=+x.Debet||0;s.c+=+x.Credit||0;s.t+=+x.Transfer||0;return s;},{d:0,c:0,t:0});
  totalDebetEl.textContent=formatRupiah(t.d);totalCreditEl.textContent=formatRupiah(t.c);totalTransferEl.textContent=formatRupiah(t.t);
  const saldo=t.c-t.d;totalSaldoEl.textContent=formatRupiah(saldo);
  totalSaldoEl.style.color=saldo>0?'var(--positive)':saldo<0?'var(--negative)':'var(--neutral)';
}

function renderChart(){
  const ctx=document.getElementById('chartBiaya').getContext('2d');if(chart)chart.destroy();
  const by={};filtered.forEach(r=>{const k=r.Kategori||'(Tanpa Kategori)';if(!by[k])by[k]={Debet:0,Credit:0,Transfer:0};
    by[k].Debet+=+r.Debet||0;by[k].Credit+=+r.Credit||0;by[k].Transfer+=+r.Transfer||0;});
  const labels=Object.keys(by),dD=labels.map(l=>by[l].Debet),dC=labels.map(l=>by[l].Credit),dT=labels.map(l=>by[l].Transfer);
  const textColor=getComputedStyle(document.body).getPropertyValue('--text');
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[
    {label:'Debet',data:dD,backgroundColor:'rgba(59,130,246,0.9)'},
    {label:'Credit',data:dC,backgroundColor:'rgba(34,197,94,0.9)'},
    {label:'Transfer',data:dT,backgroundColor:'rgba(250,204,21,0.9)'}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:c=>formatRupiah(c.raw)}},
    legend:{labels:{color:textColor}}},
    scales:{y:{beginAtZero:true,ticks:{color:textColor}},
    x:{ticks:{color:textColor}}}}});
}

[filterKategori,filterNopol,filterJenisTransaksi,quickSearch,filterStart,filterEnd]
  .forEach(e=>e.addEventListener('input',applyFilters));

document.getElementById('resetFilters').addEventListener('click',()=>{
  filterKategori.value='';filterNopol.value='';filterJenisTransaksi.value='';
  quickSearch.value='';filterStart.value='';filterEnd.value='';
  applyFilters();
});

document.getElementById('backButton').addEventListener('click',()=>window.history.back());

// ðŸŸ¢ Export ke Excel
exportExcelBtn.addEventListener('click',()=>{
  if(filtered.length===0){alert('Tidak ada data untuk diexport.');return;}
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(filtered);
  XLSX.utils.book_append_sheet(wb,ws,"Biaya Operasional");
  XLSX.writeFile(wb,"Biaya_Operasional.xlsx");
});

// ðŸŸ¢ Export ke PDF
exportPdfBtn.addEventListener('click',async()=>{
  if(filtered.length===0){alert('Tidak ada data untuk diexport.');return;}
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l","pt","a4");
  const el = document.getElementById("tableBiaya");
  const canvas = await html2canvas(el,{scale:1.4,backgroundColor:document.body.classList.contains('light-mode')?"#fff":"#0b1724"});
  const img = canvas.toDataURL("image/png");
  const width = pdf.internal.pageSize.getWidth();
  const ratio = canvas.height / canvas.width;
  const height = width * ratio;
  pdf.addImage(img,"PNG",15,20,width-30,height);
  pdf.save("Biaya_Operasional.pdf");
});

function updateHeaderDate(){
  const today=new Date().toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('smallDate').textContent=today;
}

loadData();
</script>

</body>
</html>
